<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Профиль {{ profile_user_login }}</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css" rel="stylesheet"/>
    <style>
        :root {
            --background-color: #0e0e1a;
            --card-background: #1a1a2e;
            --accent-color: #9c27b0;
            --text-color: #e0e0e0;
            --text-secondary: #a0a0a0;
            --border-color: #2a2a44;
            --button-background: #991cb1;
            --button-hover: #8e24aa;
            --golden-color: #ffd700;
            --success-color: #28a745;
            --error-color: #dc3545;
            --error-color-hover: #b71c1c;
            --warning-color: #f1c40f;
            --info-color: #17a2b8;
            --scrollbar-bg: #1a1a2e;
            --scrollbar-thumb: #9c27b0;
            --scrollbar-thumb-hover: #8e24aa;
        }
        .snowflake {
            position: absolute;
            top: -10px;
            color: #fff;
            user-select: none;
            pointer-events: none;
            z-index: 5;
            font-size: 1em;
            opacity: 0.8;
            animation: fall linear infinite;
        }
        @keyframes fall {
            to {
                transform: translateY(100vh);
                opacity: 0;
            }
        }
        @keyframes rise {
            0% {
                transform: translateY(0);
                opacity: 1;
            }
            100% {
                transform: translateY(-40px);
                opacity: 0;
            }
        }
        .goldenEffect {
            position: relative;
            display: inline-block;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
        }
        .goldenEffect .particles {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: visible;
        }
        .goldenEffect .particle {
            position: absolute;
            bottom: 0;
            width: 3px;
            height: 3px;
            background: var(--golden-color);
            border-radius: 50%;
            animation: rise 3s linear infinite;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            background-color: var(--background-color);
            color: var(--text-color);
            font-family: "Roboto", sans-serif;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
        }
        .container {
            background-color: var(--card-background);
            padding: 40px 30px;
            border-radius: 15px;
            max-width: 40%;
            width: 100%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
            z-index: 5;
            position: relative;
        }
        #snowflakes-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
            z-index: 5;
        }
        .header {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            position: relative;
        }
        .avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: #333;
            background-size: cover;
            background-position: center;
            margin-right: 20px;
            border: 3px solid var(--accent-color);
            cursor: pointer;
        }
        .header-info {
            flex: 1;
        }
        .header-info h1 {
            font-size: 2em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            color: var(--text-color);
        }
        .friend-action-container {
            position: absolute;
            top: 12px;
            right: 5px;
            display: flex;
            gap: 10px;
        }
        .action-button {
            padding: 6px 10px;
            font-size: 0.9em;
            border-radius: 6px;
        }
        #showFriendsBtn,
        #showTopBtn {
            padding: 6px 10px;
            font-size: 1.05em;
            border-radius: 6px;
        }
        .action-button:hover {
            background-color: var(--button-hover);
            transform: translateY(-2px);
        }
        .friend-action-container button {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 32px;
            cursor: pointer;
            position: relative;
        }
        .friend-action-dropdown {
            display: none;
            position: absolute;
            top: 35px;
            right: 0;
            background-color: var(--card-background);
            border: 1px solid var(--accent-color);
            padding: 8px 12px;
            border-radius: 8px;
            z-index: 10;
            white-space: nowrap;
        }
        .friend-action-dropdown span {
            cursor: pointer;
            display: block;
            color: var(--text-color);
            font-size: 1em;
        }
        .friend-action-dropdown span:hover {
            color: var(--accent-color);
        }
        .mobile-menu-container {
            position: absolute;
            top: 23px;
            right: 2px;
            display: none;
            flex-direction: column;
            align-items: flex-end;
            z-index: 20;
        }
        @media (min-width: 501px) {
            .mobile-menu-container {
                display: none !important;
            }
        }
        .mobile-menu-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 3px;
        }
        .mobile-menu-button .bar {
            display: block;
            width: 22px;
            height: 3px;
            background-color: var(--text-color);
            margin: 3px 0;
        }
        .mobile-menu-dropdown {
            display: none;
            border: none;
            background-color: transparent;
            box-shadow: none;
            margin-top: 0;
            padding: 0;
            flex-direction: column;
            align-items: flex-end;
            position: absolute;
            right: -30px;
            top: 100%;
            z-index: 20;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s ease;
        }
        .mobile-menu-dropdown.show {
            display: flex;
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .mobile-menu-dropdown span {
            background-color: transparent;
            border: 1px solid var(--accent-color);
            border-radius: 8px;
            padding: 6px 12px;
            margin: 5px 0;
            color: var(--text-color);
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease, transform 0.2s ease;
            display: block;
            font-size: 1em;
            text-align: left;
            width: 100%;
        }
        .mobile-menu-dropdown span:hover {
            background-color: var(--button-hover);
            color: #fff;
            transform: translateY(-2px);
        }
        .mobile-menu-blur-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            opacity: 0;
            visibility: hidden;
            z-index: 15;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .mobile-menu-blur-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .no-scroll {
            overflow: hidden;
        }
        .user-info {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-bottom: 30px;
        }
        .info-card {
            background-color: var(--background-color);
            padding: 20px;
            border-radius: 10px;
            flex: 1 1 30%;
            margin: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            transition: transform 0.3s ease;
        }
        .info-card:hover {
            transform: translateY(-5px);
        }
        .info-card h3 {
            margin-bottom: 10px;
            font-size: 1.2em;
            color: var(--accent-color);
        }
        .info-card p {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--text-color);
        }
        .history-game {
            margin-bottom: 30px;
        }
        .history-game h2 {
            margin-bottom: 20px;
            color: var(--accent-color);
            text-align: center;
        }
        .history-table-wrapper {
            max-height: 450px;
            overflow-y: auto;
            border-radius: 10px;
            background-color: var(--background-color);
            border: 1px solid var(--border-color);
            padding: 0 10px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        thead {
            background-color: var(--accent-color);
            position: sticky;
            top: 0;
            z-index: 1;
            border-radius: 10px 10px 0 0;
        }
        th,
        td {
            padding: 12px 15px;
            text-align: left;
            color: var(--text-color);
        }
        th {
            font-weight: 500;
        }
        tbody tr:nth-child(even) {
            background-color: #2a2a44;
        }
        tbody tr:hover {
            background-color: #3a3a58;
        }
        .result-win {
            color: var(--success-color);
            font-weight: bold;
        }
        .result-lose {
            color: var(--error-color);
            font-weight: bold;
        }
        .result-draw {
            color: var(--warning-color);
            font-weight: bold;
        }
        .result-not_started {
            color: var(--text-secondary);
            font-weight: bold;
        }
        .result-unknown {
            color: var(--info-color);
            font-weight: bold;
        }
        .buttons {
            text-align: center;
            margin-top: 20px;
        }
        .buttons button {
            background-color: var(--button-background);
            color: #fff;
            border: none;
            padding: 12px 25px;
            margin: 0 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        .buttons button:hover {
            background-color: var(--button-hover);
            transform: translateY(-3px);
        }
        .load-more-button,
        .hide-button {
            background-color: var(--accent-color);
        }
        .hide-button {
            display: none;
            background-color: #555;
        }
        .history-table-wrapper::-webkit-scrollbar {
            width: 12px;
        }
        .history-table-wrapper::-webkit-scrollbar-track {
            background: var(--scrollbar-bg);
            border-radius: 10px;
        }
        .history-table-wrapper::-webkit-scrollbar-thumb {
            background-color: var(--scrollbar-thumb);
            border-radius: 10px;
            border: 3px solid var(--scrollbar-bg);
        }
        .history-table-wrapper::-webkit-scrollbar-thumb:hover {
            background-color: var(--scrollbar-thumb-hover);
        }
        .history-table-wrapper {
            scrollbar-width: thin;
            scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-bg);
        }
        @keyframes fade-down-custom {
            from {
                opacity: 0;
                transform: translateY(-40px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        [data-aos="fade-down-custom"] {
            animation: fade-down-custom 1s ease forwards;
        }
        .fade-in {
            animation: fadeIn 0.5s ease forwards;
            opacity: 0;
        }
        @keyframes fadeIn {
            to {
                opacity: 1;
            }
        }
        .fade-out {
            animation: fadeOut 0.3s ease forwards;
        }
        @keyframes fadeOut {
            to {
                opacity: 0;
                height: 0;
                padding: 0;
                margin: 0;
            }
        }
        #notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 300px;
            max-width: 90%;
            z-index: 9999;
        }
        .notification {
            position: relative;
            background: #333;
            color: #fff;
            padding: 10px 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            animation: fadeIn 0.5s;
            cursor: pointer;
            overflow: hidden;
        }
        .notification.success {
            background-color: var(--success-color);
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        .progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background-color: #fff;
            width: 100%;
            animation: progress 2s linear forwards;
        }
        @keyframes progress {
            0% {
                width: 100%;
            }
            100% {
                width: 0;
            }
        }
        @media (max-width: 1690px) {
            .container {
                max-width: 45%;
            }
        }
        @media (max-width: 1510px) {
            .container {
                max-width: 50%;
            }
        }
        @media (max-width: 1360px) {
            .container {
                max-width: 55%;
            }
        }
        @media (max-width: 1240px) {
            .container {
                max-width: 60%;
            }
        }
        @media (max-width: 1145px) {
            .container {
                max-width: 65%;
            }
        }
        @media (max-width: 1060px) {
            .container {
                max-width: 70%;
            }
        }
        @media (max-width: 985px) {
            .container {
                max-width: 75%;
            }
        }
        @media (max-width: 920px) {
            .container {
                max-width: 80%;
            }
        }
        @media (max-width: 870px) {
            .container {
                max-width: 85%;
            }
        }
        @media (max-width: 820px) {
            .container {
                max-width: 90%;
            }
        }
        @media (max-width: 775px) {
            .container {
                max-width: 95%;
            }
        }
        @media (max-width: 735px) {
            .container {
                max-width: 100%;
            }
        }
        @media (max-width: 500px) {
            {% if is_own_profile %}
            .friend-action-container {
                display: none;
            }
            .mobile-menu-container {
                display: flex;
            }
            {% endif %}
            [data-aos],
            .fade-in,
            [data-aos="fade-down-custom"] {
                opacity: 1 !important;
                transform: none !important;
                animation: none !important;
                transition: none !important;
            }
        }
        @media (max-width: 369px) and (min-width: 355px) {
            .history-table-wrapper th,
            .history-table-wrapper td {
                font-size: calc(0.94em);
                padding: calc(10px) calc(12px);
            }
        }
        @media (max-width: 370px) {
            .buttons button {
                padding: 8px 15px;
                font-size: 0.9em;
                margin: 0 5px;
            }
            .friend-action-container {
                position: absolute;
                top: 8px;
                right: 5px;
            }
            .user-info .info-card {
                padding: 15px;
                margin: 8px;
            }
            .user-info .info-card h3 {
                font-size: 0.9em;
            }
            .user-info .info-card p {
                font-size: 1em !important;
            }
            .avatar {
                width: 80px;
                height: 80px;
            }
            .header-info h1 {
                font-size: 1.2em;
            }
            .header-info p {
                font-size: 0.8em;
            }
        }
        @media (max-width: 425px) {
            .history-table-wrapper th,
            .history-table-wrapper td {
                font-size: calc(0.85em - 0.1rem);
                padding: calc(8px - 0.1rem) calc(10px - 0.1rem);
            }
            .user-info .info-card {
                padding: calc(15px - 0.2rem);
                margin: calc(8px - 0.2rem);
            }
            .user-info .info-card h3 {
                font-size: calc(1em - 0.2rem);
            }
            .user-info .info-card p {
                font-size: calc(1.2em - 0.2rem);
            }
            .avatar {
                width: calc(80px - 0.2rem);
                height: calc(80px - 0.2rem);
            }
            .header-info h1 {
                font-size: calc(1.5em - 0.2rem);
            }
            .friend-action-container {
                position: absolute;
                top: 7px;
                right: 5px;
            }
            .mobile-menu-container {
                top: 10px;
            }
        }
        @media (max-width: 317px) {
            .avatar {
                width: calc(80px - 2rem);
                height: calc(80px - 2rem);
                margin-right: 15px;
            }

            .friend-action-container {
                position: absolute;
                top: 1px;
                right: 5px;
            }
            .header-info h1 {
                font-size: calc(2em - 1em);
            }
            .mobile-menu-container {
                top: 1px !important;
            }
            .header-info p {
                font-size: calc(0.9em - 0.2rem);
            }
            .history-table-wrapper th,
            .history-table-wrapper td {
                font-size: calc(0.85em - 0.2rem);
                padding: calc(8px - 0.2rem) calc(10px - 0.2rem);
            }
            .buttons button {
                padding: 8px 15px;
                font-size: 0.6em;
                margin: 0 5px;
            }
            .mobile-menu-container {
                top: 7px;
            }
        }
        @media (min-width: 485px) and (max-width: 560px) {
            .history-table-wrapper th,
            .history-table-wrapper td {
                font-size: calc(0.90em);
                padding: calc(10px) calc(12px);
            }
        }
        @media (min-width: 370px) and (max-width: 484px) {
            .history-table-wrapper th,
            .history-table-wrapper td {
                font-size: calc(0.84em);
                padding: calc(10px) calc(12px);
            }
        }
        @media (max-width: 700px) {
            .user-info {
                display: flex;
                justify-content: center;
                align-items: center;
            }
            .user-info .info-card:nth-child(1),
            .user-info .info-card:nth-child(2),
            .user-info .info-card:nth-child(3) {
                display: none;
            }
            .user-info .info-card:nth-child(4) {
                margin: 0 auto;
                cursor: pointer;
            }
        }
        .info-modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .info-modal.show {
            display: flex;
            opacity: 1;
        }
        .info-modal-content {
            background: linear-gradient(145deg, #2a2a50, #1a1a2e);
            padding: 40px 50px;
            border-radius: 15px;
            color: #ffffff;
            text-align: center;
            position: relative;
            max-width: 90%;
            width: 500px;
            margin: 0 auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
            animation: fadeInModal 0.4s ease forwards;
            transform: scale(0.9);
        }
        .info-modal-content h3 {
            margin: 20px 0;
            font-size: 1.4em;
            color: #ffffff;
        }
        .close-button {
            position: absolute;
            top: 15px;
            right: 20px;
            cursor: pointer;
            color: #ffffff;
            font-size: 1.8rem;
            transition: color 0.3s ease;
        }
        .friend-modal-content .close-button {
            position: absolute;
            top: 5px;
            right: 10px;
            font-size: 28px !important;
            cursor: pointer;
            color: var(--text-color);
            transition: transform 0.2s ease, color 0.3s ease;
        }
        .friend-modal-content .close-button:hover {
            color: var(--accent-color);
            transform: scale(1.1);
        }
        .close-button:hover {
            color: var(--accent-color);
        }
        #avatarActions {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid var(--accent-color);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            text-align: center;
            display: none;
        }
        #avatarActions button,
        #avatarActions form button {
            background-color: var(--button-background);
            color: #fff;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        #avatarActions button:hover,
        #avatarActions form button:hover {
            background-color: var(--button-hover);
            transform: translateY(-2px);
        }
        .friend-modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        .friend-modal-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border-radius: 15px;
            box-shadow: 0 15px 45px rgba(0, 0, 0, 0.8);
            padding: 60px 70px;
            color: #fff;
            text-align: center;
            position: relative;
            max-width: 500px;
            width: 90%;
            opacity: 0;
            transform: translateY(-20px);
            animation: fadeInUp 0.4s ease forwards;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .friend-modal-content button {
            font-size: 1.1rem;
            padding: 14px 28px;
            background-color: var(--button-background);
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 20px;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .friend-modal-content h3 {
            font-size: 1.6rem;
            margin-bottom: 1.2rem;
        }
        .friend-modal-content button:hover {
            background-color: var(--button-hover);
        }
        .search-user-item {
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 2px 5px;
            background-color: #1e1e30;
            margin-bottom: 5px;
        }
        .search-user-item span {
            color: #eee;
            font-size: 1em;
        }
        .search-user-item button {
            background: none;
            border: none;
            color: #eee;
            font-size: 1.3em;
            cursor: pointer;
            transition: color 0.3s ease;
            margin-top: 4px;
        }
        .search-user-item button:focus,
        .search-user-item button:active,
        .search-user-item button:hover {
            outline: none !important;
            box-shadow: none !important;
            background: none !important;
        }
        #removeFriendModal {
            display: none;
            position: fixed;
            z-index: 99999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        #removeFriendModal .remove-modal-content {
            background: linear-gradient(145deg, #4d223a, #371629);
            border-radius: 20px;
            box-shadow: 0 15px 45px rgba(0, 0, 0, 0.8);
            animation: fadeInModal 0.4s ease forwards;
            transform: scale(1.1);
            padding: 40px 60px;
            color: #fff;
            text-align: center;
            position: relative;
            max-width: 450px;
            width: 90%;
            transition: all 0.3s ease;
        }
        #removeFriendModal .remove-modal-content button {
            font-size: 1rem;
            padding: 14px 28px;
            background-color: var(--button-background);
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 20px 10px 0 10px;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        #removeFriendModal .remove-modal-content button:hover {
            background-color: var(--button-hover);
        }
        #return-to-game {
            position: absolute;
            bottom: 20px;
            background: var(--card-background);
            border: 2px solid var(--button-background);
            border-radius: 15px;
            padding: 20px;
            width: 80%;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 255, 150, 0.3);
            display: none;
            z-index: 5;
        }
        #return-to-game h2 {
            font-size: 1.5rem;
            color: var(--success-color);
            margin-bottom: 10px;
        }
        #return-to-game p {
            font-size: 1rem;
            margin-bottom: 20px;
        }
        #return-to-game .button {
            background-color: var(--warning-color);
            color: #fff;
            padding: 12px 25px;
            margin: 0 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border: none;
        }
        #return-to-game .button.leave-button {
            background-color: var(--error-color);
        }
        #return-to-game .button.leave-button:hover {
            background-color: var(--error-color-hover);
        }
        #return-to-game .button + .button {
            margin-left: 15px;
        }
        #leave-game-modal,
        #game-over-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 5;
        }
        #leave-game-modal {
            background: rgba(0, 0, 0, 0.6);
        }
        #game-over-modal {
            background: rgba(0, 0, 0, 0.6);
            z-index: 5;
        }
        .modal-content {
            background: var(--card-background);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            color: var(--text-color);
            max-width: 90%;
            width: 400px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            transition: box-shadow 0.3s ease-out, transform 0.3s ease-out;
        }
        #leave-game-modal .modal-content h2 {
            margin-bottom: 20px;
            color: var(--error-color);
        }
        #game-over-modal .modal-content h2 {
            margin-bottom: 20px;
            color: var(--warning-color);
        }
        #leave-game-modal .modal-content p,
        #game-over-modal .modal-content p {
            margin-bottom: 30px;
            font-size: 1rem;
        }
        .modal-content .button {
            width: auto;
            padding: 12px 25px;
            margin: 10px 5px;
            border-radius: 8px;
            font-size: 1em;
            background-color: var(--button-background);
            color: #fff;
            border: none;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .modal-content .button:hover {
            background-color: var(--button-hover);
            transform: translateY(-3px);
        }
        #leave-game-modal .button.confirm-button {
            background-color: var(--error-color);
        }
        #leave-game-modal .button.confirm-button:hover {
            background-color: var(--error-color-hover);
        }
        #game-over-modal .modal-content {
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.5);
        }
        input:-webkit-autofill,
        input:-webkit-autofill:hover,
        input:-webkit-autofill:focus,
        textarea:-webkit-autofill,
        textarea:-webkit-autofill:hover,
        textarea:-webkit-autofill:focus,
        select:-webkit-autofill,
        select:-webkit-autofill:hover,
        select:-webkit-autofill:focus {
            -webkit-text-fill-color: var(--text-color) !important;
            box-shadow: 0 0 0 1000px var(--card-background) inset !important;
            transition: background-color 5000s ease-in-out 0s !important;
        }
        #friendSearchContainer {
            position: relative;
            margin: 0 0 15px -25px;
            display: flex;
            align-items: center;
            width: 113%;
            max-width: 500px;
            border-radius: 8px;
            overflow: hidden;
            background-color: #222;
            box-shadow: inset 0 0 8px rgba(0,0,0,0.4);
        }
        #friendSearchContainer .search-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 10px;
        }
        #friendSearchContainer .clear-search {
            background: transparent;
            border: none;
            color: #fff;
            cursor: pointer;
            font-size: 1.2em;
            padding: 10px 15px;
            margin: 0;
            outline: none;
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
        }
        #friendSearchContainer .clear-search::before {
            content: "\00d7";
            display: block;
        }
        #friendSearchContainer input {
            flex: 1;
            padding: 15px;
            border: none;
            outline: none;
            font-size: 1em;
            background-color: transparent;
            color: #eee;
        }
        #friendSearchContainer input::placeholder {
            color: #ccc;
        }
        #friendSearchContainer button {
            padding: 10px 15px;
            background: none;
            border: none;
            color: #fff;
            cursor: pointer;
            font-size: 1.2em;
            transition: color 0.3s ease;
            margin-top: -4px;
        }
        #friendSearchContainer button:hover {
            color: var(--accent-color);
        }
        #friendsListContainer .search-user-item span {
            font-size: 1.1em;
            margin-left: 10px;
        }
        .three-dot-dropdown {
            position: absolute;
            right: 0;
            top: 100%;
            margin-top: 5px;
            display: none;
            background-color: var(--card-background);
            border: 1px solid var(--accent-color);
            border-radius: 8px;
            padding: 6px 10px;
            z-index: 44;
        }
        .three-dot-dropdown div {
            color: var(--text-color);
            padding: 5px 0;
            cursor: pointer;
        }
        .three-dot-dropdown div:hover {
            color: var(--accent-color);
        }
        .dropdown-container {
            position: relative;
        }
        @media (max-width: 375px) {
            .mobile-menu-dropdown {
                display: none;
            }

            .mobile-menu-dropdown.show {
                display: flex;
                flex-direction: column;
                align-items: flex-end;
                padding: 0;
                background-color: transparent;
                position: absolute;
                right: -30px;
                top: 100%;
                z-index: 20;
                opacity: 1;
                visibility: visible;
                transform: translateY(0);
            }

            .mobile-menu-dropdown span {
                font-size: 0.8em;
                padding: 4px 8px;
                margin: 3px 0;
                display: block;
                width: 100%;
                text-align: left;
            }

            .mobile-menu-dropdown span:hover {
                transform: translateY(-1px);
            }

            .mobile-menu-container {
                top: 14px;
                right: 5px;
            }

            .mobile-menu-button {
                padding: 5px;
            }

            .mobile-menu-button .bar {
                width: 18px;
                height: 2px;
                margin: 2px 0;
            }
        }
        .mobile-menu-blur-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            opacity: 0;
            visibility: hidden;
            z-index: 15;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .mobile-menu-blur-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .mobile-menu-dropdown {
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s ease;
        }
        .mobile-menu-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .no-scroll {
            overflow: hidden;
        }
        .top-players-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .player-card {
            background-color: var(--card-background);
            border: 4px solid transparent;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            width: 180px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
            margin: 10px;
            position: relative;
            overflow: hidden;
            animation: fadeInUp 0.6s ease forwards;
            opacity: 0;
            transform: translateY(20px);
            transition: box-shadow 0.3s ease, transform 0.3s ease;
        }

        .player-card:hover {
            box-shadow: 0 12px 25px rgba(0,0,0,0.5);
            transform: translateY(0);
        }

        .player-card.first {
            border-image: linear-gradient(45deg, #ffd700, #ffea00);
            border-image-slice: 1;
        }

        .player-card.second,
        .player-card.third {
            border-style: solid;
            border-width: 4px;
        }

        .player-card.second {
            border-image: linear-gradient(45deg, #c0c0c0, #dcdcdc) 1;
        }

        .player-card.third {
            border-image: linear-gradient(45deg, #cd7f32, #b87333) 1;
        }

        .player-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-size: cover;
            background-position: center;
            margin: 0 auto 15px auto;
            border: 2px solid #fff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        .player-login {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--text-color);
            margin-bottom: 5px;
        }

        .player-rang {
            font-size: 1em;
            color: var(--text-secondary);
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .player-profile-link {
            color: var(--text-color);
            text-decoration: none;
            position: relative;
            transition: color 0.3s ease;
        }

        .player-profile-link::after {
            content: '';
            position: absolute;
            width: 0%;
            height: 2px;
            display: block;
            margin-top: 5px;
            right: 0;
            background: var(--accent-color);
            transition: width 0.3s ease;
            border-radius: 2px;
        }

        .player-profile-link:hover {
            color: var(--accent-color);
        }

        .player-profile-link:hover::after {
            width: 100%;
            left: 0;
            background: linear-gradient(90deg, var(--accent-color), var(--golden-color));
        }
        .info-modal-content,
            .friend-modal-content,
            .modal-content {
                max-height: 90vh;
                overflow-y: auto;
                overflow-x: hidden;
            }

            .info-modal-content::-webkit-scrollbar,
            .friend-modal-content::-webkit-scrollbar,
            .modal-content::-webkit-scrollbar {
                width: 8px;
            }

            .info-modal-content::-webkit-scrollbar-track,
            .friend-modal-content::-webkit-scrollbar-track,
            .modal-content::-webkit-scrollbar-track {
                background: var(--scrollbar-bg);
                border-radius: 10px;
            }

            .info-modal-content::-webkit-scrollbar-thumb,
            .friend-modal-content::-webkit-scrollbar-thumb,
            .modal-content::-webkit-scrollbar-thumb {
                background-color: var(--scrollbar-thumb);
                border-radius: 10px;
            }

            .info-modal-content,
            .friend-modal-content,
            .modal-content {
                scrollbar-width: thin;
                scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-bg);
            }

            #incomingFriendRequestsSection {
                margin-bottom: 15px;
            }

            #incomingFriendRequestsSection h3 {
                margin-bottom: 15px;
                color: #fff;
                font-size: 1.5em;
                text-align: center;
            }

            .incoming-friend-request-item {
                height: 62px;
                position: relative;
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 5px;
                background-color: #1e1e30;
                margin-bottom: 5px;
                color: #fff;
                width: 100%;
                box-sizing: border-box;
            }

            .incoming-friend-request-item.decline {
                background-color: #dc3545;
            }

            .incoming-friend-request-item .username {
                color: #fff;
                font-size: 1.1em;
                margin-left: 20px;
            }

            .incoming-friend-request-item .accept-btn::before,
            .incoming-friend-request-item .decline-btn::before {
                font-family: Arial, sans-serif;
            }

            #friendsListContainer .player-profile-link {
                margin-left: 20px;
                color: #fff;
                font-size: 1.1em;
                transition: color 0.3s ease;
            }

            .incoming-friend-request-item .action-buttons {
                display: flex;
                gap: 10px;
            }

            .incoming-friend-request-item .action-buttons button.accept-btn {
                background-color: #28a745;
                color: #fff;
                border: none;
                border-radius: 4px;
                padding: 5px;
                cursor: pointer;
                font-size: 1.2em;
                transition: opacity 0.2s ease;
            }

            .incoming-friend-request-item .action-buttons button.decline-btn {
                background-color: #dc3545;
                color: #fff;
                border: none;
                border-radius: 4px;
                padding: 5px;
                cursor: pointer;
                font-size: 1.2em;
                transition: opacity 0.2s ease;
            }

            .incoming-friend-request-item .action-buttons {
                padding-right: 10px;
            }

            .incoming-friend-request-item .action-buttons button.accept-btn,
            .incoming-friend-request-item .action-buttons button.decline-btn {
                background: none;
                border: none;
                color: #fff;
                padding: 5px;
                font-size: 1.2em;
                cursor: pointer;
                transition: color 0.3s ease;
            }

            .incoming-friend-request-item .action-buttons button {
                margin-bottom: 20px;
                background: none;
                border: none;
                cursor: pointer;
                font-size: 1.2em;
                color: #fff;
                transition: transform 0.2s ease;
            }

            .incoming-friend-request-item .action-buttons button:hover {
                opacity: 0.8;
            }

            .incoming-friend-request-item .action-buttons button.accept-btn:hover {
                color: var(--success-color);
            }

            .incoming-friend-request-item .action-buttons button.decline-btn:hover {
                color: var(--error-color);
            }

            .incoming-friend-request-item .accept-btn::before {
                content: "✔";
            }

            .incoming-friend-request-item .decline-btn::before {
                content: "✖";
            }
            @media (max-width: 768px) {
                .incoming-friend-request-item .action-buttons button.accept-btn {
                    color: var(--success-color);
                }
                .incoming-friend-request-item .action-buttons button.decline-btn {;
                    color: var(--error-color);
                }
                #showFriendsBtn:hover,
                #showTopBtn:hover,
                #showFriendsBtn:active,
                #showTopBtn:active {
                    background-color: transparent;
                    transform: none;
                }
            }
            @media (max-width: 350px) {
                #incomingFriendRequestsSection {
                    padding: 5px 10px;
                }

                #incomingFriendRequestsSection h3 {
                    font-size: 0.85em;
                }

                .incoming-friend-request-item {
                    height: 34px;
                    padding: 2px;
                }

                .incoming-friend-request-item .username {
                    font-size: 0.8em;
                    margin-left: 5px;
                }

                .incoming-friend-request-item .action-buttons button.accept-btn,
                .incoming-friend-request-item .action-buttons button.decline-btn {
                    font-size: 1em;
                    padding: 2px;
                }

                #friendsListContainer {
                    padding: 5px 10px;
                }

                #friendsListContainer .search-user-item span {
                    font-size: 0.9em;
                    margin-left: 5px;
                }

                #friendsModalHeading {
                    font-size: 0.85em;
                }

                #friendsListContainer .search-user-item {
                    padding: 3px 5px;
                }

                #friendsListContainer .player-profile-link {
                    font-size: 0.8em;
                    margin-left: 5px;
                }

                #friendsListContainer .search-user-item button {
                    font-size: 1em;
                    padding: 2px 4px;
                }

                .player-card {
                    width: 140px;
                    padding: 15px;
                }

                .player-avatar {
                    width: 60px;
                    height: 60px;
                }

                .player-login {
                    font-size: 1em;
                }

                .player-rang {
                    font-size: 0.9em;
                }
                 #friendSearchContainer {
                    margin: 0 0 10px -10px;
                    width: 120%;
                }

                #friendSearchContainer .search-icon {
                    padding: 0 5px;
                    width: 30px;
                    height: 30px;
                }

                #friendSearchContainer input {
                    padding: 8px;
                    font-size: 0.9em;
                }

                #friendSearchContainer button:not(.clear-search) {
                    padding: 8px 12px;
                    font-size: 1em;
                }
                .three-dot-dropdown div {
                    font-size: 0.7em;
                    padding: 2px 0;
                }

                .three-dot-dropdown div:hover {
                    font-size: 0.7em;
                }
            }
    </style>
</head>
<body>
    <div id="snowflakes-container"></div>
    <div class="container">
        <div class="header">
            <div class="avatar" data-aos="fade-down-custom" style="background-image: url('{{ user_avatar_url|default('/static/avatars/default_avatar.jpg') }}');" {% if is_own_profile %}onclick="toggleAvatarActions()" {% endif %}></div>
            <div class="header-info" data-aos="fade-left">
                <h1>
                    {% if profile_user_login == 'WertRar' %}
                    <span class="nickname goldenEffect">
                        {{ profile_user_login }}
                        <span class="particles">
                            <span class="particle" style="left:7%; animation-delay:0.1s;"></span>
                            <span class="particle" style="left:23%; animation-delay:0.3s;"></span>
                            <span class="particle" style="left:48%; animation-delay:0.5s;"></span>
                            <span class="particle" style="left:16%; animation-delay:0.8s;"></span>
                            <span class="particle" style="left:71%; animation-delay:0.4s;"></span>
                            <span class="particle" style="left:39%; animation-delay:1.0s;"></span>
                            <span class="particle" style="left:85%; animation-delay:0.6s;"></span>
                            <span class="particle" style="left:55%; animation-delay:1.2s;"></span>
                            <span class="particle" style="left:30%; animation-delay:0.7s;"></span>
                            <span class="particle" style="left:93%; animation-delay:1.4s;"></span>
                        </span>
                    </span>
                    {% else %}
                    <span class="nickname">{{ profile_user_login }}</span>
                    {% endif %}
                </h1>
                <p>Рейтинг: {{ rang }}</p>
            </div>
            {% if is_own_profile %}
            <div class="friend-action-container">
                <button id="showFriendsBtn" onclick="openFriendsModal()" class="action-button">Друзья</button>
                <button id="showTopBtn" onclick="openTopModal()" class="action-button">Топ</button>
            </div>
            {% else %}
            <div class="friend-action-container">
                <button id="friendActionBtn" onclick="toggleFriendAction()">⋮</button>
                <div id="friendActionDropdown" class="friend-action-dropdown">
                    <span id="friendActionText"></span>
                </div>
            </div>
            {% endif %}
            <div class="mobile-menu-container">
                <button class="mobile-menu-button" onclick="toggleMobileMenu()">
                    <span class="bar"></span>
                    <span class="bar"></span>
                    <span class="bar"></span>
                </button>
                <div id="mobileMenuDropdown" class="mobile-menu-dropdown">
                    <span onclick="openFriendsModal(); toggleMobileMenu();">Друзья</span>
                    <span onclick="openTopModal(); toggleMobileMenu();">Топ</span>
                </div>
                <div id="mobileMenuBlurOverlay" class="mobile-menu-blur-overlay" onclick="toggleMobileMenu()"></div>
            </div>
        </div>
        {% if is_own_profile %}
        <div id="avatarActions">
            <button type="button" onclick="document.getElementById('avatarFileInput').click();">Загрузить аватар</button>
            {% if user_avatar_url != '/static/avatars/default_avatar.jpg' %}
            <form id="deleteAvatarForm" action="/delete_avatar" method="post" style="display:inline;">
                <button type="submit">Удалить аватар</button>
            </form>
            {% endif %}
        </div>
        {% endif %}
        <div class="user-info">
            <div class="info-card" data-aos="fade-up" data-aos-delay="100">
                <h3>Побед</h3>
                <p>{{ wins }}</p>
            </div>
            <div class="info-card" data-aos="fade-up" data-aos-delay="200">
                <h3>Ничьих</h3>
                <p>{{ draws }}</p>
            </div>
            <div class="info-card" data-aos="fade-up" data-aos-delay="300">
                <h3>Поражений</h3>
                <p>{{ losses }}</p>
            </div>
            <div class="info-card" data-aos="fade-up" data-aos-delay="400" onclick="openInfoModal()">
                <h3>Игры сыграно</h3>
                <p>{{ total_games }}</p>
            </div>
        </div>
        <div class="history-game" id="history-game" data-aos="fade-up" data-aos-delay="500">
            <h2>История игр</h2>
            <div class="history-table-wrapper" id="history-table-wrapper">
                <table>
                    <thead>
                    <tr>
                        <th>Дата (окончания)</th>
                        <th>Рейтинг</th>
                        <th>Результат</th>
                    </tr>
                    </thead>
                    <tbody id="history-tbody"></tbody>
                </table>
            </div>
            <div class="buttons">
                <button id="loadMoreButton" class="load-more-button">Загрузить ещё</button>
                <button id="hideButton" class="hide-button">Скрыть</button>
            </div>
        </div>
        <div class="buttons">
            <form id="avatarForm" action="/upload_avatar" method="post" enctype="multipart/form-data" style="display:inline;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="file" name="avatar" id="avatarFileInput" accept=".png,.jpg,.jpeg,.gif" style="display:none;" onchange="document.getElementById('avatarForm').submit();"/>
            </form>
            <button class="home-button" onclick="goReturn()">Вернуться</button>
            {% if is_own_profile %}
            <button class="logout-button" onclick="logout()">Выйти</button>
            {% endif %}
        </div>
    </div>
    <div id="return-to-game">
        <h2>У вас есть активная игра</h2>
        <p>Вы можете вернуться к вашей текущей игре.</p>
        <button class="button" onclick="returnToGame()">Вернуться</button>
        <button class="button leave-button" onclick="showLeaveGameModal()">Покинуть</button>
    </div>
    <div id="info-modal" class="info-modal">
        <div class="info-modal-content" id="modal-content">
            <span class="close-button" onclick="closeInfoModal()">&times;</span>
            <h3>Побед: {{ wins }}</h3>
            <h3>Ничьих: {{ draws }}</h3>
            <h3>Поражений: {{ losses }}</h3>
        </div>
    </div>
    <div id="friendModal" class="friend-modal">
        <div class="friend-modal-content">
            <span class="close-button" onclick="closeFriendModal()">&times;</span>
            <p>Отправить запрос в друзья пользователю <strong>{{ profile_user_login }}</strong>?</p>
            <button onclick="sendFriendRequest()">Добавить в друзья</button>
        </div>
    </div>
    <div id="friendsModal" class="friend-modal">
        <div class="friend-modal-content" id="friendsModalContent">
            <span class="close-button" onclick="closeFriendsModal()">&times;</span>
            <div id="friendSearchContainer">
                <div class="search-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24">
                        <path fill="#ccc" d="M9.5 3C13.09 3 16 5.91 16 9.5c0 1.61-.59 3.08-1.57 4.22l5.42 5.42-1.41 1.41-5.42-5.42C12.58 15.41 11.11 16 9.5 16 5.91 16 3 13.09 3 9.5S5.91 3 9.5 3m0 2C7.02 5 5 7.02 5 9.5S7.02 14 9.5 14 14 11.98 14 9.5 11.98 5 9.5 5Z" />
                    </svg>
                </div>
                <input type="text" id="friendSearchInput" placeholder="Поиск пользователей..." />
                <button type="button" class="clear-search" title="Очистить"></button>
            </div>
            <div id="incomingFriendRequestsSection" style="display: none;">
                <h3>Предложения дружбы</h3>
                <div id="incomingFriendRequestsContainer"></div>
            </div>
            <h3 id="friendsModalHeading">Ваши друзья</h3>
            <div id="friendsListContainer"></div>
        </div>
    </div>
    <div id="removeFriendModal">
        <div class="remove-modal-content">
            <span class="close-button" onclick="closeRemoveFriendModal()">&times;</span>
            <p>Удалить пользователя <strong id="removeFriendName"></strong> из друзей?</p>
            <button onclick="confirmRemoveFriend()">Удалить</button>
            <button onclick="closeRemoveFriendModal()">Отмена</button>
        </div>
    </div>
    <div id="leave-game-modal">
        <div class="modal-content">
            <h2>Подтверждение выхода</h2>
            <p>Вы точно хотите покинуть игру? Это будет считаться поражением и вы потеряете ранг.</p>
            <button class="button confirm-button" onclick="leaveGame()">Да</button>
            <button class="button" onclick="hideLeaveGameModal()">Отмена</button>
        </div>
    </div>
    <div id="game-over-modal">
        <div class="modal-content">
            <h2>Игра окончена</h2>
            <p id="game-over-message"></p>
            <button class="button" onclick="hideGameOverModal()">Закрыть</button>
        </div>
    </div>
    <div id="top-modal" class="info-modal">
        <div class="info-modal-content" id="topModalContent">
            <span class="close-button" onclick="closeTopModal()">&times;</span>
            <h3>Топ игроков</h3>
            <div id="topPlayersContainer" class="top-players-container">
            </div>
        </div>
    </div>
    <div id="notification-container"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const origin = urlParams.get('origin');
        const isOwnProfile = {{ 'true' if is_own_profile else 'false' }};
        let returnUrl = "";

        if (origin === "room") {
            returnUrl = "/room/" + "{{ room_id }}";
        } else if (origin === "friends" || origin === "top" || origin === "profile") {
            returnUrl = "/profile/" + encodeURIComponent("{{ session['user'] if 'user' in session else '' }}");
        } else if (isOwnProfile) {
            returnUrl = "/";
        } else {
            returnUrl = null;
        }

        function goReturn(){
            if(returnUrl){
                window.location.href = returnUrl;
            }
            else{
                history.back();
            }
        }

        let game_id = null;
        const user_login = "{{ session['user'] if 'user' in session else '' }}";
        let allRecords = {{ user_history|tojson }}.reverse();
        let currentIndex = 0;
        let pageSize = 9;
        let friendToRemove = "";
        let myFriends = [];
        const requestsSent = new Set();

        document.addEventListener("DOMContentLoaded", () => {
            AOS.init({ duration: 800, easing: "ease-in-out", once: true });

            fetch("/get_friends")
            .then(response => response.json())
            .then(data => {
                if (data.friends) {
                    myFriends = data.friends;
                }
            })
            .catch(() => {});

            loadRecords();
            document.getElementById("loadMoreButton").addEventListener("click", loadRecords);
            document.getElementById("hideButton").addEventListener("click", hideRecords);

            document.getElementById("info-modal").addEventListener("click", (e) => {
                if (e.target === document.getElementById("info-modal")) {
                    closeInfoModal();
                }
            });

            document.addEventListener("click", (e) => {
                let friendsModal = document.getElementById("friendsModal");
                if (friendsModal.style.display === "flex" && !e.target.closest("#friendsModalContent") && !e.target.closest("#removeFriendModal")) {
                    closeFriendsModal();
                }
                let friendActionDropdown = document.getElementById("friendActionDropdown");
                if (friendActionDropdown && !friendActionDropdown.contains(e.target) && e.target.id !== "friendActionBtn") {
                    friendActionDropdown.style.display = "none";
                }
                let mobileMenuDropdown = document.getElementById("mobileMenuDropdown");
                if (mobileMenuDropdown && mobileMenuDropdown.classList.contains("show") && !mobileMenuDropdown.contains(e.target) && !e.target.closest(".mobile-menu-button")) {
                    toggleMobileMenu();
                }
                const allDropdowns = document.querySelectorAll(".three-dot-dropdown");
                allDropdowns.forEach(dropdown => {
                    if (!dropdown.contains(e.target) && !e.target.matches(".search-user-item button")) {
                        dropdown.style.display = "none";
                    }
                });
            });

            createSnowflakes();
            generateSnowflakes();
            checkForActiveGame();
            setInterval(checkForActiveGame, 5000);

            let notifications = document.querySelectorAll(".notification");
            notifications.forEach((notif) => {
                notif.addEventListener("click", () => {
                    notif.style.transition = 'opacity 0.5s';
                    notif.style.opacity = '0';
                    setTimeout(() => { notif.remove(); }, 500);
                });
                setTimeout(() => {
                    notif.style.transition = 'opacity 0.5s';
                    notif.style.opacity = '0';
                    setTimeout(() => { notif.remove(); }, 500);
                }, 2000);
            });
            const clearBtn = document.querySelector("#friendSearchContainer .clear-search");
            const searchInput = document.getElementById("friendSearchInput");

            if (clearBtn && searchInput) {
                clearBtn.addEventListener("click", () => {
                    searchInput.value = "";
                    loadFriendsList();
                });
            }
        });

        function returnToGame() {
            if (game_id && user_login) {
                window.location.href = "/board/" + game_id + "/" + user_login;
            } else {
                alert("Активная игра не найдена.");
            }
        }

        document.getElementById('avatarFileInput').addEventListener('change', () => {
            const formData = new FormData(document.getElementById('avatarForm'));
            fetch('/upload_avatar', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token() }}'
                }
            });
        });

        function showLeaveGameModal() {
            document.getElementById("leave-game-modal").style.display = "flex";
        }

        function hideLeaveGameModal() {
            document.getElementById("leave-game-modal").style.display = "none";
        }

        function hideGameOverModal() {
            document.getElementById("game-over-modal").style.display = "none";
        }

        function leaveGame() {
            if (game_id && user_login) {
                fetch("/give_up", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ game_id: game_id, user_login: user_login })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                    } else {
                        hideLeaveGameModal();
                        document.getElementById("return-to-game").style.display = "none";
                        displayGameOverMessage(data);
                    }
                })
                .catch(() => {
                    alert("Произошла ошибка при покидании игры.");
                });
            } else {
                alert("Активная игра не найдена.");
            }
        }

        function displayGameOverMessage(data) {
            let modal = document.getElementById("game-over-modal");
            let message = document.getElementById("game-over-message");
            let resultText = "";
            if (data.result === "win") {
                resultText = "Поздравляем! Вы победили!";
            } else if (data.result === "lose") {
                resultText = "Вы проиграли.";
            } else if (data.result === "draw") {
                resultText = "Ничья.";
            }
            let points_gained = data.points_gained || 0;
            let points_text = points_gained >= 0
                ? "Вы получили " + points_gained + " очков к рангу."
                : "Вы потеряли " + Math.abs(points_gained) + " очков к рангу.";
            message.innerHTML = resultText + "<br>" + points_text;
            modal.style.display = "flex";
        }

        function checkForActiveGame() {
            fetch('/check_game_status')
                .then(response => {
                    if (response.status === 200) {
                        return response.json();
                    } else {
                        throw new Error('Нет активной игры.');
                    }
                })
                .then(data => {
                    if (data.status === 'active' || data.status === 'waiting') {
                        if (data.game_id) {
                            game_id = data.game_id;
                        }
                        document.getElementById('return-to-game').style.display = 'block';
                    } else {
                        document.getElementById('return-to-game').style.display = 'none';
                    }
                })
                .catch(() => {
                    document.getElementById('return-to-game').style.display = 'none';
                });
        }

        function createSnowflakes() {
            let snowContainer = document.getElementById("snowflakes-container");
            let snowflakeCount = 50;
            for (let i = 0; i < snowflakeCount; i++) {
                let snowflake = document.createElement("div");
                snowflake.classList.add("snowflake");
                snowflake.textContent = "❄";
                snowflake.style.left = Math.random() * 100 + "vw";
                snowflake.style.fontSize = Math.random() * 10 + 10 + "px";
                snowflake.style.opacity = Math.random();
                snowflake.style.animationDuration = Math.random() * 5 + 5 + "s";
                snowflake.style.animationDelay = Math.random() * 10 + "s";
                snowContainer.appendChild(snowflake);
            }
        }

        function generateSnowflakes() {
            let container = document.getElementById("snowflakes-container");
            for (let i = 0; i < 50; i++) {
                let snowflake = document.createElement("div");
                snowflake.classList.add("snowflake");
                snowflake.textContent = "❄";
                snowflake.style.fontSize = Math.random() * 10 + 10 + "px";
                snowflake.style.left = Math.random() * 100 + "vw";
                snowflake.style.animationDuration = Math.random() * 3 + 2 + "s";
                snowflake.style.animationDelay = Math.random() * 5 + "s";
                container.appendChild(snowflake);
            }
        }

        function formatDate(dateString) {
            let options = {
                year: "numeric",
                month: "2-digit",
                day: "2-digit",
                hour: "2-digit",
                minute: "2-digit",
                second: "2-digit"
            };
            let date = new Date(dateString);
            return date.toLocaleString("ru-RU", options);
        }

        function loadRecords() {
            var tbody = document.getElementById("history-tbody");
            var endIndex = Math.min(currentIndex + pageSize, allRecords.length);
            for (var i = currentIndex; i < endIndex; i++) {
                var record = allRecords[i];
                var tr = document.createElement("tr");
                tr.classList.add("fade-in");

                var dateTd = document.createElement("td");
                dateTd.textContent = formatDate(record.date_start);
                tr.appendChild(dateTd);

                var ratingTd = document.createElement("td");
                var ratingChange = record.rating_change >= 0 ? "(+" + record.rating_change + ")" : "(" + record.rating_change + ")";
                ratingTd.textContent = record.rating_after + " " + ratingChange;
                tr.appendChild(ratingTd);

                var resultTd = document.createElement("td");
                var resultClass = "";
                var resultText = "";
                if (record.result === "win") {
                    resultClass = "result-win";
                    resultText = "Победа";
                } else if (record.result === "lose") {
                    resultClass = "result-lose";
                    resultText = "Поражение";
                } else if (record.result === "draw") {
                    resultClass = "result-draw";
                    resultText = "Ничья";
                } else if (record.result === "not_started") {
                    resultClass = "result-not_started";
                    resultText = "Не началась";
                } else {
                    resultClass = "result-unknown";
                    resultText = "Неизвестный результат";
                }
                var span = document.createElement("span");
                span.className = resultClass;
                span.textContent = resultText;
                resultTd.appendChild(span);

                tr.appendChild(resultTd);
                tbody.appendChild(tr);
            }
            currentIndex = endIndex;
            updateButtons();
            AOS.refresh();
        }

        function hideRecords() {
            var tbody = document.getElementById("history-tbody");
            var rows = tbody.querySelectorAll("tr");
            for (var i = pageSize; i < rows.length; i++) {
                rows[i].classList.remove("fade-in");
                rows[i].classList.add("fade-out");
                setTimeout(function(row) {
                    row.remove();
                }.bind(null, rows[i]), 300);
            }
            setTimeout(function() {
                currentIndex = pageSize;
                updateButtons();
            }, 300);
        }

        function updateButtons() {
            var loadMoreBtn = document.getElementById("loadMoreButton");
            var hideBtn = document.getElementById("hideButton");
            if (currentIndex > pageSize) {
                hideBtn.style.display = "inline-block";
            } else {
                hideBtn.style.display = "none";
            }
            if (currentIndex >= allRecords.length) {
                loadMoreBtn.style.display = "none";
            } else {
                loadMoreBtn.style.display = "inline-block";
            }
        }

        function logout() {
            window.location.href = "/logout";
        }

        function openInfoModal() {
            var modal = document.getElementById("info-modal");
            if (window.innerWidth <= 700) {
                modal.classList.add("show");
            }
        }

        function closeInfoModal() {
            var modal = document.getElementById("info-modal");
            modal.classList.remove("show");
        }

        function toggleAvatarActions() {
            var actions = document.getElementById("avatarActions");
            actions.style.display = (actions.style.display === "none" || actions.style.display === "") ? "block" : "none";
        }

        function openFriendModal() {
            document.getElementById("friendModal").style.display = "flex";
        }

        function closeFriendModal() {
            document.getElementById("friendModal").style.display = "none";
        }

        function showNotification(message, category) {
            var container = document.getElementById("notification-container");
            var notif = document.createElement("div");
            notif.className = "notification " + category;
            notif.innerHTML = message + '<div class="progress-bar"></div>';
            notif.addEventListener("click", function() {
                notif.style.transition = 'opacity 0.5s';
                notif.style.opacity = '0';
                setTimeout(function() {
                    notif.remove();
                }, 500);
            });
            container.appendChild(notif);
            setTimeout(function() {
                notif.style.transition = 'opacity 0.5s';
                notif.style.opacity = '0';
                setTimeout(function() {
                    notif.remove();
                }, 500);
            }, 2000);
        }

        function sendFriendRequest() {
            fetch("/send_friend_request", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ friend_username: "{{ profile_user_login }}" })
            })
            .then(response => response.json())
            .then(data => {
                showNotification(data.message, "success");
                closeFriendModal();
            })
            .catch(() => {
                showNotification("Ошибка при отправке запроса", "error");
            });
        }

        function openFriendsModal() {
            fetch("/get_friends")
            .then(response => response.json())
            .then(data => {
                var container = document.getElementById("friendsListContainer");
                container.innerHTML = "";
                if (data.friends && data.friends.length > 0) {
                    myFriends = data.friends;
                    data.friends.forEach(friend => {
                        var friendDiv = document.createElement("div");
                        friendDiv.className = "search-user-item dropdown-container";

                        var link = document.createElement("a");
                        link.href = "/profile/" + encodeURIComponent(friend) + "?origin=friends";
                        link.textContent = friend;
                        link.className = "player-profile-link";

                        var btn = document.createElement("button");
                        btn.textContent = "⋮";

                        var dropdown = document.createElement("div");
                        dropdown.className = "three-dot-dropdown";
                        var removeDiv = document.createElement("div");
                        removeDiv.textContent = "Удалить из друзей";
                        removeDiv.onclick = function() {
                            openRemoveFriendModal(friend);
                            dropdown.style.display = "none";
                        };
                        dropdown.appendChild(removeDiv);

                        btn.onclick = function(e) {
                            e.stopPropagation();
                            const isOpen = dropdown.style.display === "block";
                            closeAllDropdowns();
                            dropdown.style.display = isOpen ? "none" : "block";
                        };

                        friendDiv.appendChild(link);
                        friendDiv.appendChild(btn);
                        friendDiv.appendChild(dropdown);
                        container.appendChild(friendDiv);
                    });
                } else {
                    container.innerHTML = "<p style='color:#ccc; text-align:center;'>Список друзей пуст</p>";
                }

                loadIncomingFriendRequests();

                document.getElementById("friendsModal").style.display = "flex";
            })
            .catch(() => {
                showNotification("Ошибка загрузки списка друзей", "error");
            });
        }

        function loadIncomingFriendRequests() {
            fetch("/get_friend_requests")
            .then(response => response.json())
            .then(data => {
                var incomingSection = document.getElementById("incomingFriendRequestsSection");
                var requestsContainer = document.getElementById("incomingFriendRequestsContainer");
                requestsContainer.innerHTML = "";

                if (data.requests && data.requests.length > 0) {
                    incomingSection.style.display = "block";
                    data.requests.forEach(requester => {
                        var requestDiv = document.createElement("div");
                        requestDiv.className = "incoming-friend-request-item";

                        var usernameLink = document.createElement("a");
                        usernameLink.className = "username player-profile-link";
                        usernameLink.href = "/profile/" + encodeURIComponent(requester) + "?origin=profile";
                        usernameLink.textContent = requester;

                        var actionsDiv = document.createElement("div");
                        actionsDiv.className = "action-buttons";

                        var acceptBtn = document.createElement("button");
                        acceptBtn.className = "accept-btn";
                        acceptBtn.title = "Принять";

                        var declineBtn = document.createElement("button");
                        declineBtn.className = "decline-btn";
                        declineBtn.title = "Отклонить";

                        acceptBtn.onclick = function() {
                            respondToFriendRequest(requester, true, requestDiv);
                        };

                        declineBtn.onclick = function() {
                            respondToFriendRequest(requester, false, requestDiv);
                        };

                        actionsDiv.appendChild(acceptBtn);
                        actionsDiv.appendChild(declineBtn);

                        requestDiv.appendChild(usernameLink);
                        requestDiv.appendChild(actionsDiv);

                        requestsContainer.appendChild(requestDiv);
                    });
                } else {
                    incomingSection.style.display = "none";
                }
            })
            .catch(() => {
                showNotification("Ошибка загрузки предложений дружбы", "error");
            });
        }

        function respondToFriendRequest(senderUsername, accept, requestDiv) {
            const endpoint = "/respond_friend_request";
            const response = accept ? "accept" : "decline";

            fetch(endpoint, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    sender_username: senderUsername,
                    response: response
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    showNotification(data.message, accept ? "success" : "info");
                    requestDiv.remove();
                    const remainingRequests = document.getElementById("incomingFriendRequestsContainer").children.length;
                    if (remainingRequests === 0) {
                        document.getElementById("incomingFriendRequestsSection").style.display = "none";
                    }
                } else if (data.error) {
                    showNotification(data.error, "error");
                }
            })
            .catch(() => {
                showNotification("Ошибка при обработке запроса", "error");
            });
        }

        function closeFriendsModal() {
            document.getElementById("friendsModal").style.display = "none";
            document.getElementById("friendSearchInput").value = "";
            loadFriendsList();
        }

        function openRemoveFriendModal(friendUsername) {
            friendToRemove = friendUsername;
            document.getElementById("removeFriendName").textContent = friendUsername;
            document.getElementById("removeFriendModal").style.display = "flex";
        }

        function closeRemoveFriendModal() {
            document.getElementById("removeFriendModal").style.display = "none";
            friendToRemove = "";
        }

        function confirmRemoveFriend() {
            removeFriend(friendToRemove);
        }

        function removeFriend(friendUsername) {
            fetch("/remove_friend", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ friend_username: friendUsername })
            })
            .then(response => response.json())
            .then(data => {
                showNotification(data.message, "success");
                closeRemoveFriendModal();
                loadFriendsList();
            })
            .catch(() => {
                showNotification("Ошибка при удалении друга", "error");
            });
        }

        function toggleFriendAction() {
            var dropdown = document.getElementById("friendActionDropdown");
            if (dropdown.style.display === "block") {
                dropdown.style.display = "none";
                return;
            }

            closeAllDropdowns();

            fetch("/get_friends")
            .then(response => response.json())
            .then(data => {
                var isFriend = false;
                if (data.friends && data.friends.includes("{{ profile_user_login }}")) {
                    isFriend = true;
                }
                var actionText = document.getElementById("friendActionText");
                if (isFriend) {
                    actionText.textContent = "Удалить из друзей";
                    actionText.onclick = function() {
                        openRemoveFriendModal("{{ profile_user_login }}");
                        dropdown.style.display = "none";
                    };
                } else {
                    actionText.textContent = "Добавить в друзья";
                    actionText.onclick = function() {
                        addFriendAction();
                        dropdown.style.display = "none";
                    };
                }
                dropdown.style.display = "block";
                setTimeout(function() {
                    dropdown.style.display = "none";
                }, 3000);
            })
            .catch(() => {});
        }

        function addFriendAction() {
            fetch("/send_friend_request", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ friend_username: "{{ profile_user_login }}" })
            })
            .then(response => response.json())
            .then(data => {
                showNotification(data.message, "success");
            })
            .catch(() => {
                showNotification("Ошибка при отправке запроса", "error");
            });
        }

        function toggleMobileMenu() {
            var dropdown = document.getElementById("mobileMenuDropdown");
            var overlay = document.getElementById("mobileMenuBlurOverlay");
            dropdown.classList.toggle("show");
            overlay.classList.toggle("active");
            document.body.classList.toggle("no-scroll");
        }

        function loadFriendsList() {
            fetch("/get_friends")
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById("friendsListContainer");
                    const heading = document.getElementById("friendsModalHeading");
                    heading.textContent = "Ваши друзья";
                    container.innerHTML = "";
                    if(data.friends && data.friends.length > 0){
                        myFriends = data.friends;
                        data.friends.forEach(friend => {
                            var friendDiv = document.createElement("div");
                            friendDiv.className = "search-user-item dropdown-container";
                            var span = document.createElement("span");
                            span.textContent = friend;
                            var btn = document.createElement("button");
                            btn.textContent = "⋮";

                            var dropdown = document.createElement("div");
                            dropdown.className = "three-dot-dropdown";
                            var removeDiv = document.createElement("div");
                            removeDiv.textContent = "Удалить из друзей";
                            removeDiv.onclick = function() {
                                openRemoveFriendModal(friend);
                                dropdown.style.display = "none";
                            };
                            dropdown.appendChild(removeDiv);

                            btn.onclick = function(e) {
                                e.stopPropagation();
                                dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
                            };

                            friendDiv.appendChild(span);
                            friendDiv.appendChild(btn);
                            friendDiv.appendChild(dropdown);
                            container.appendChild(friendDiv);
                        });
                    } else {
                        container.innerHTML = "<p style='color:#ccc; text-align:center;'>Список друзей пуст</p>";
                    }
                })
                .catch(() => {
                    showNotification("Ошибка загрузки списка друзей", "error");
                });
        }

        document.getElementById("friendSearchInput").addEventListener("input", function(){
            const query = this.value.trim();
            if(query.length >= 1){
                fetch("/search_users?query=" + encodeURIComponent(query))
                    .then(response => response.json())
                    .then(data => {
                        displaySearchResults(data.results);
                    })
                    .catch(() => {
                        showNotification("Ошибка при поиске пользователей", "error");
                    });
            } else {
                loadFriendsList();
                loadIncomingFriendRequests();
            }
        });

        function displaySearchResults(results) {
            const container = document.getElementById("friendsListContainer");
            const heading = document.getElementById("friendsModalHeading");
            heading.textContent = "Найденные пользователи";
            container.innerHTML = "";
            const currentUser = "{{ session['user'] if 'user' in session else '' }}";
            const filteredResults = results.filter(user => user !== currentUser);
            if (filteredResults.length === 0) {
                container.innerHTML = "<p style='color:#ccc; text-align:center;'>Пользователи не найдены</p>";
                return;
            }
            filteredResults.forEach(user => {
                const userDiv = document.createElement("div");
                userDiv.className = "search-user-item dropdown-container";

                const link = document.createElement("a");
                link.href = "/profile/" + encodeURIComponent(user) + "?origin=search";
                link.textContent = user;
                link.className = "player-profile-link";

                const btn = document.createElement("button");
                btn.textContent = "⋮";

                const dropdown = document.createElement("div");
                dropdown.className = "three-dot-dropdown";

                if (myFriends.includes(user)) {
                    const alreadyFriendDiv = document.createElement("div");
                    alreadyFriendDiv.textContent = "Этот пользователь уже у вас в друзьях";
                    dropdown.appendChild(alreadyFriendDiv);
                } else if (requestsSent.has(user)) {
                    const alreadySentDiv = document.createElement("div");
                    alreadySentDiv.textContent = "Вы уже отправляли запрос этому пользователю";
                    dropdown.appendChild(alreadySentDiv);
                } else {
                    const addDiv = document.createElement("div");
                    addDiv.textContent = "Добавить в друзья";
                    addDiv.onclick = function() {
                        fetch("/send_friend_request", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ friend_username: user })
                        })
                        .then(response => response.json())
                        .then(data => {
                            showNotification(data.message, "success");
                            requestsSent.add(user);
                            dropdown.style.display = "none";
                            document.getElementById("friendSearchInput").value = "";
                            loadFriendsList();
                        })
                        .catch(() => {
                            showNotification("Ошибка при отправке запроса", "error");
                        });
                    };
                    dropdown.appendChild(addDiv);
                }

                btn.onclick = function(e) {
                    e.stopPropagation();
                    const isOpen = dropdown.style.display === "block";
                    closeAllDropdowns();
                    dropdown.style.display = isOpen ? "none" : "block";
                };

                userDiv.appendChild(link);
                userDiv.appendChild(btn);
                userDiv.appendChild(dropdown);
                container.appendChild(userDiv);
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            const friendSearchInput = document.getElementById('friendSearchInput');

            function updatePlaceholder() {
                if (window.innerWidth <= 300) {
                    friendSearchInput.placeholder = "По...";
                } else if (window.innerWidth <= 420) {
                    friendSearchInput.placeholder = "Поиск...";
                } else {
                    friendSearchInput.placeholder = "Поиск пользователей...";
                }
            }
            updatePlaceholder();
            window.addEventListener('resize', updatePlaceholder);
        });

        function closeAllDropdowns() {
            const dropdowns = document.querySelectorAll('.three-dot-dropdown');
            dropdowns.forEach(dropdown => {
                dropdown.style.display = 'none';
            });
        }

        function openTopModal() {
            fetch("/get_top_players")
            .then(response => response.json())
            .then(data => {
                if (data.top_players) {
                    var container = document.getElementById("topPlayersContainer");
                    container.innerHTML = "";

                    data.top_players.forEach((player, index) => {
                        var card = document.createElement("div");
                        card.classList.add("player-card");

                        if (index === 0) {
                            card.classList.add("first");
                        } else if (index === 1) {
                            card.classList.add("second");
                        } else if (index === 2) {
                            card.classList.add("third");
                        }

                        var profileLink = document.createElement("a");
                        profileLink.href = "/profile/" + encodeURIComponent(player.login) + "?origin=top";
                        profileLink.style.textDecoration = "none";
                        profileLink.style.color = "inherit";

                        var avatar = document.createElement("div");
                        avatar.classList.add("player-avatar");
                        avatar.style.backgroundImage = `url('${player.avatar_url}')`;

                        var login = document.createElement("div");
                        login.classList.add("player-login");
                        login.textContent = player.login;

                        var rang = document.createElement("div");
                        rang.classList.add("player-rang");
                        rang.textContent = "Ранг: " + player.rang;

                        profileLink.appendChild(avatar);
                        profileLink.appendChild(login);
                        profileLink.appendChild(rang);

                        card.appendChild(profileLink);

                        container.appendChild(card);
                    });
                } else if (data.error) {
                    alert(data.error);
                }
                document.getElementById("top-modal").classList.add("show");
            })
            .catch(() => {
                alert("Не удалось загрузить топ игроков.");
            });
        }

        function closeTopModal() {
            document.getElementById("top-modal").classList.remove("show");
        }

        document.getElementById("top-modal").addEventListener("click", function(event) {
            if (event.target === this) {
                closeTopModal();
            }
        });
        document.addEventListener("DOMContentLoaded", () => {
            const messages = {{ get_flashed_messages(with_categories=true)|tojson }};
                messages.forEach(([category, message]) => {
                    showNotification(message, category);
                });
        });
    </script>
</body>
</html>
