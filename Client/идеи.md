**Идеи**

1) Адаптивный дизайн нужен

2) Нормальный рейтинг в плане выдачи ранга

3) Проверить условия ничьи в игре:

3.1) Если один из участников предлагает ничью, а другой принимает это предложение.

3.2) Если в партии, играющейся с контрольными часами, истекло время у обоих участников и невозможно установить, кто просрочил время раньше.

3.3) Если участник, имея в окончании партии три дамки против одной дамки соперника и владея при этом «большой дорогой», своим 15-м ходом (считая с момента установления соотношения сил) не совершит взятие дамки соперника.

3.4) Если участник имеет в окончании партии три дамки и более шашек (простых шашек и дамок) против одной дамки соперника, своим 15-м ходом (считая с момента установления соотношения сил) не совершит взятие дамки противника.

3.5) Если в позиции, в которой оба соперника имеют дамки, не изменилось соотношение сил (т. е. не было взятия, и ни одна простая шашка не стала дамкой) на протяжении:

3.6) в 2-х и 3-х фигурных окончаниях — 5 ходов,

3.7) в 4-х и 5-и фигурных окончаниях — 30 ходов,

3.8) в 6-и и 7-и фигурных окончаниях — 60 ходов.

3.9) Если в явно ничейной позиции участник, желающий играть на выигрыш, своим 5-м ходом не сможет добиться выигранной позиции.

3.10) Если участник, имея в окончании партии три шашки (три дамки, две дамки и простую шашку, дамку и две простые шашки, три простые шашки) против одинокой дамки соперника, находящейся на «большой дороге», своим 5-м ходом не сможет совершить взятие дамки соперника.

3.11) Если в течение 15 ходов игроки делали ходы только дамками, не передвигая простых шашек и не производя взятия.

3.12) Если три (или более) раза повторяется одна и та же позиция (одно и то же расположение шашек), причем очередь хода каждый раз будет за одной и той же стороной.

4) Чтобы можно было просматривать в профиле полноценную историю игры (как шашки стояли в какой момент и т.д.)

5) Реклама

6) Redis, WebSocket

7) Сейчас после принятия друга список друзей не обновляется автоматически, надо закрыть а потом открыть еще раз список,
чтобы обновился

8) Надо чтобы комната расформировывалась, когда
сыграли партию например. Если предложение вступить в комнату есть - оно может быть только одно (в плане от 1 человека 1 приглашение)

9) Добавить кнопку реванша


 **Реализованные идеи:**

1) Сервер с шашками (Сделал)

2) Таймер (Сделал)

3) Сделать так, чтобы если юзер вышел и вошел обратно ему высвечивалось 
предложение вернуться в игру или покинуть ее (Сделал)

4) Добавить звуки хода шашек (Сделал)
Не только ходы, добавил на: победу, поражение, ходы и нахождение игры

5) Сделать игру без регистрации **(Приоритет)** (Сделал)

6) Сделать бота намного сложнее и умнее (Сделал)

7) Защита от sql инъекций (Сделал)

8) Сетевая игра для незареганого (Сделал для пользователя со стороны)

9) Сделать иконку сверху браузера (около title) (Сделал)

10) Возле WertRar коронку сделать (Сделал)

11) Новогоднее настроение для шашек :)

12) Сделать выбор по уровню сложности бота (Сделал)

13) Сделать бота еще сильнее (Сделал)

14) Если пользователь не зареган после окончания игры он не должен получать очки, должно высветиться типа
вы могли бы получать рейтинг, в таком духе предложения выйти в главное меню или зарегаться (Сделал)

15) Сделать выбор по цвету в одиночке (Сделал)

16) Добавил в профиль историю игр (Сделал)

17) Если пользователь не определенное время - проигрывает (Сделал)

18) Новое оформление, уведомления, убраны требования для пароля по просьбам (Сделал)

19) Добавил аватары игрокам (Сделал)

20) Добавить "Друзей" (Сделал)

21) Надо добавить возврат на доску через профиль (Если есть игра) (Сделал)

22) Сделать поиск по зареганным юзерам, с возможностью добавлять их в друзья также (Сделал)

23) Надо добавить цифру, сколько уведомлений есть сейчас непрочитанных (Сделал)

24) Сделал так, чтобы юзер если пытается отправить еще запросы - ему писалось, что уже отправляли запрос этому юзеру,
а если уже в друзьях тоже уведомление - что вы уже друзья (Сделал)

25) Надо чтобы когда ищешь друга писалось не ваши друзья, а найденные пользователи типа, что-то в таком духе (Сделал)

26) Чтобы юзер сам себя не искал и не добавлял в друзья (Сделал)

27) Добавил кнопку запомнить пароль (Сделал)

28) Cделал так, чтобы при нажатии на никнейм я переходил в профиль ( в друзьях и при поиске друга ) (Сделал)

29) Добавил топ игроков (топ 3) - там тоже можно переходить в профиля (Сделал)

30) Надо сделать чтобы юзеры могли принимать запросы о дружбе и через профиль также (Сделал)

31) Добавил значок человечка около уведомлений (Сделал)

32) Ограничить попытки регистрации (Сделал)

33) Взаимодействие с друзьями (типа приглашать в игру и т.д.) (Сделал)

34) Проверка фоток, загружаемые на аву (Сделал)

35) Оптимизировать запросы базы данных (Сделал)

ПЕРВАЯ ЧАСТЬ:

**register_user**

Перед добавлением пользователя, вызывается check_user_exists. Однако check_user_exists
создает новый запрос, что лишний раз нагружает базу данных.
Вместо этого можно попытаться добавить пользователя и обработать IntegrityError, если такой логин уже существует.

**get_user_by_login**

Используется dict(user), но Player не является стандартным словарем.
Лучше создать метод to_dict() в модели Player и использовать его.

Упрощение кода (отделение логики сериализации).
Легче расширять (если добавятся новые поля).

**update_user_rang**

func.coalesce(Player.rang, 0) защищает от NULL значений
Исправлена ошибка с Player.rang + points (Player.rang + points не работает корректно, так как Player.rang – это объект класса Column)


**get_user_history**

Теперь каждый объект CompletedGames может конвертироваться в dict корректно и предсказуемо
session.scalars(select(...)) сразу возвращает список CompletedGames, а не ResultProxy, что делает код чище
.all() возвращает список всех записей
Теперь вместо dict(game_history), который не работал, используется game.to_dict()

**get_top_players**

Упрощенный код.
Использование to_dict(), что делает функцию универсальной.

ВТОРАЯ ЧАСТЬ ЧАСТЬ:

Использование транзакций к функциям **register_user**, **update_user_rang**, **update_user_stats**, **add_completed_game**,
**send_friend_request_db**, **remove_friend_db**.

Регистрация пользователя – предотвращает добавление дубликатов
Обновление рейтинга и статистики – гарантирует корректное обновление данных либо вообще никакое
Добавление завершенной игры – все изменения вносятся одновременно
Отправка запросов в друзья – предотвращает дублирующиеся или несогласованные записи
Удаление друзей – гарантирует удаление обеих записей связи



36) Инвайт пользователей (Сделал)

37) Сделать возможность перехода в профиль через комнату (Сделал)

38) Добавил возможность выбора цвета, за который будут играть юзеры (из комнаты) (Сделал)

39) Cделал так, чтобы было видно, что пользователь отклонил приглашение. При нажатии на кнопку отклонено - инвайт 
отправляется снова (Сделал)

 **Баги:**







 **ПОФИКШЕННЫЕ БАГИ:**

1) Дамки пропадают при просмотре истории игры (Пофиксил)

2) Когда ничья - дается +2 игры (Пофиксил)

3) Когда игрок находивший игру быстрее сдавался или выходил с нее - у второго игрока был бесконечный поиск (Пофиксил)

4) Сделать чтобы нельзя было делать русские буквы и символы в логине (Пофиксил)

5) Время иногда багается - сделать так, чтобы время начинало идти только после того, как оба игрока
загрузятся (Пофиксил)

6) Неправильная отрисовка (Пофиксил)
Суть - для белых все нормально
Для черных - нет

7) Неправильный показ фигур в истории ходов (Пофиксил)

8) Когда обновляешь страничку за черных - во время загрузки вместо черных фигур белые стоят, но потом все
нормально (Пофиксил)

9) Когда игрок полностью выходит со своего профиля, заходит обратно - ему не предлагает вернуться в игру (Пофиксил)

10) Один раз было, что после множественного захвата (и не только) выдавало ошибку, мол not your tern, хотя я уже 
походил и сейчас ходят другие фигуры. Примечание: возникает именно на сервере такая ошибка, на локальном компьютере
все нормально (Пофиксил)

11) Выдало ошибку на доске undefind и потом написало game id не найден
Это все было во время игры (Пофиксил)

12) Почему-то иногда багается сам канвас в процессе игры --- фигуры 1 раз пропали, после обновления странички все 
исправилось и больше не появлялось. Примечание: возникает именно на сервере такая ошибка, на локальном компьютере
все нормально.  (Пофиксил)

13) Иногда багается что-то и выдает ошибку 403, будто у вас нет допуска к этой игре,
хотя он должен быть (Пофиксил)

14) Иногда игра заканчивается тогда, когда она не должна еще закончиться (Пофиксил)

15) Неправильное отображение расположения шашек, при просмотре за черных (показывает как черные шашки повторяют ход
за белыми) (Пофиксил)

16) Когда прекращают поиск юзеры остается запись в базе данных что игрок играл с null (Пофиксил)

17) Посмотреть есть ли возможность в сетевой игре игроку зайти за другого игрока (ghost, в том числе) (Пофиксил)

18) Сейчас прыгают шашки от актуального состояния в изначальное и обратно. Из-за этого происходит повторение ходов в
игры. (Пофиксил)

По факту баг пофиксил... но грубо говоря я записываю каждый ход в БД и от туда берется информация
Если есть варик сделать лучше надо подумать будет

19) TypeError: 'Player' object is not subscriptable

В base.py функция get_user_by_login была изменена так, чтобы возвращать пользователя в виде словаря, используя dict(user). 
Это обеспечивает возможность обращения к атрибутам пользователя по ключам, например, user["avatar_filename"].

20) 'Player' object is not iterable:

В классе Player в models.py был добавлен метод __iter__, который позволяет объекту быть итерируемым. 
Этот метод возвращает пары ключ-значение атрибутов объекта, что позволяет использовать
dict(player_obj) для преобразования объекта в словарь.

21) Был баг с показом игр в профиле - решился просто заменой wins=user['wins'] на wins=wins.

22) Был баг с выдачей ранга в моменте opp_rank_before = base.get_user_by_login(opponent_login).rang и похожих - исправил
на opp_rank_before = base.get_user_by_login(opponent_login)["rang"] и похожих.





 **Комментарии к решению проблем:**

1) Проблема с отображением дамок при просмотре истории игры заключалась в том, что информация
о превращении шашки в дамку mode или is_king не сохранялась и не передавалась корректно клиентской части.
Решение:
* Добавил флаг promotion_occurred для отслеживания превращения шашки в дамку
  и изменял его в validate_move если происходило превращение
* Добавил передачу promotion по promotion_occurred в функцию validate_move и move для передачи на клиент

2) Проблема с увеличением счёта ничьих на +2 вместо +1 возникла из-за двойной обработки события ничьей
в двух разных маршрутах на серверной стороне. Исправив это путем удаления обновления статистики из маршрута
/respond_draw_route и оставив обновление статистики только в маршруте /update_board, избежали
двойного увеличения счёта ничьих

3) Изменил логику обработки ситуаций, когда игра завершается или невозможно присоединиться к существующей партии

4) Ну просто запретил вписывать это

5) Просто сделал так, чтобы время прогружалось тогда, когда оба игрока прогрузятся на board

6) Я исправил неправильную отрисовку координат в списке ходов, изменив функцию преобразования координат
в зависимости от цвета игрока. Теперь, если игрок играет за чёрных, координаты отражаются по горизонтали
и вертикали, чтобы они соответствовали его перспективе на доске.

7) Когда я добавил переворот доски в функциях viewBoardState и returnToCurrentView, это помогло 
правильно отображать фигуры для черных игроков при просмотре истории ходов.

8) Убрал начальную инициализацию pieces с уже заданными фигурами. Теперь при загрузке страницы сразу делаем
запрос к серверу (server_update_request()) и ожидаем данные о расстановке фигур. После получения данных переводим
их для чёрных и только потом запускаем отрисовку и опрос состояния игры

9) При повторном входе система проверяет, есть ли у пользователя активная игра,
и если да, устанавливает соответствующие данные в сессии

10) Если вкратце сказать - баг был из-за словарей. Сделал БД postgresql для хранения игр и их статусов

11) Если ход не игрока просто для него показывается пустой массив ходов

12) 13) 14) Просто создал базу данных PostgreSQL, где хранятся игры.
**Примечание**
В будущем надо поменьше использовать словари

15) Исправил отображение истории шашек, добавив переворот координат ходов для чёрного игрока непосредственно
в функцию updateMovesList

16) Не добавляю запись в БД о том что игра не начата

17) Просто проверка через сессию
